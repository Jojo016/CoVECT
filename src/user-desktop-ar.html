<!DOCTYPE html>

<!--
<!DOCTYPE html>
<html>
  <head>
    <script>
      console.log("BabelScript loading...");
    </script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script>
      console.log("BabelScript loaded.");
    </script>
    <script type="text/jsx" src="/index.js"></script>
  </head>
  <body> 
    <div id="root">
    </div>
    <script type="text/babel" src="./index.js"></script>
  </body>
</html>
-->

<html>
  <head>
    <meta charset="utf-8" />
    <title>Select & move objects</title>
    <meta name="description" content="Ownership Transfer Example MODIFIED— Networked-Aframe" />

    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.5.0/socket.io.slim.js"></script>
    <script src="/easyrtc/easyrtc.js"></script>
    <script src="/dist/networked-aframe.min.js"></script>
    <script src="/dist/aframe-material.min.js"></script>
    <script>
      // see issue https://github.com/networked-aframe/networked-aframe/issues/267
      NAF.schemas.getComponentsOriginal = NAF.schemas.getComponents;
      NAF.schemas.getComponents = (template) => {
        if (!NAF.schemas.hasTemplate('#avatar-template')) {
          NAF.schemas.add({
            template: '#avatar-template',
            components: [
              'position',
              'rotation',
              {
                selector: '.head',
                component: 'material',
                property: 'color'
              },
              'scale'
            ]
          });

          if (!NAF.schemas.hasTemplate('#block-template')) {
            NAF.schemas.add({
              template: '#block-template',
              components: [
                'position',
                {
                  selector: '.block',
                  component: 'rotation'
                },
                {
                  selector: '.block',
                  component: 'position'
                },
                {
                  selector: '.block',
                  component: 'material',
                  property: 'color'
                },
                {
                  selector: '.block',
                  component: 'select-entity',
                  property: 'direction'
                }
              ]
            });
          }
        }
        const components = NAF.schemas.getComponentsOriginal(template);
        return components;
      };
    </script>
    <script>
      AFRAME.registerComponent('selectable', {
        schema: {
          targetable: {default: true}
        },

        init: function () {
          var data = this.data;
          var el = this.el; 
          var pEl = el.parentEl;

          // Get component id
          var componentId = pEl.getAttribute('cid');

          // Create data object to stringify
          var obj = new Object();
          obj.cid = componentId;

          var entityData = JSON.stringify(obj); 

          // Add click listener
          el.addEventListener('click', function() {
            var targetable = data.targetable;
            if(targetable) {
              console.log("Sending: 'Select object with component-id:' " + entityData);
              easyrtc.sendDataWS(clientRtcId, "selectComponent", entityData);
            }else{
              console.log("Tried to select untargetable entity.");
            }
          });
        }
      });
    </script>
    <script src="https://unpkg.com/aframe-randomizer-components@^3.0.1/dist/aframe-randomizer-components.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.1/dist/aframe-environment-component.min.js"></script>
    <script src="/js/spawn-in-circle.component.js"></script>
    <script src="/js/object-control-desktop.component.js"></script>
    <script>
      let clientRtcId;

      // Called by Networked-Aframe when connected to server
      function onConnect() {        
        // Set clients easyrtcid
        clientRtcId = NAF.clientId;
        clientName = window.parent.clientName;

        // Send clientId to statusbar
        //window.parent.addUserToStatusBar(clientRtcId, true);
        serverJoinedSetup();
      }
    </script>
    <script>
      function sendToServer(command, data) {
        if(command == 'addNewObject') {
          // Get shape from data
          var shape = data;

          // Get player position
          var player = document.getElementById('player');
          var pos3 = player.getAttribute('position');

          // Create data object to stringify
          var obj = new Object();
          obj.shape = shape;
          obj.posX = pos3.x;
          obj.posY = pos3.y;
          obj.posZ = pos3.z;
          obj.color = "#0000FF"; 

          data = JSON.stringify(obj);

          console.log("Sending: 'Create new object with data:' " + data);
          easyrtc.sendDataWS(clientRtcId, "addNewObject", data);

        }else if(command == 'removeComponent'){
          // Get shape from data
          var cid = data;

          // Create data object to stringify
          var obj = new Object();
          obj.cid = cid;

          data = JSON.stringify(obj);

          console.log("Sending: 'Remove component with cid:' " + cid);
          easyrtc.sendDataWS(clientRtcId, "removeComponent", data);

        }else if(command == 'addInteraction'){
          // Get type & position from data
          var type = data.type;

          data = JSON.stringify(data);

          console.log("Sending: 'Add interaction of type:' " + type);
          easyrtc.sendDataWS(clientRtcId, command, data);

        }else if(command == 'addTask'){
          easyrtc.sendDataWS(clientRtcId, command, data);

        }else if(command == 'selectTasks'){
          data = JSON.stringify(data);
          if(tasksSelectedBy == null) {
            easyrtc.sendDataWS(clientRtcId, command, data);
          }
        }
      }

      function serverJoinedSetup() {
        // Add own name to statusbar
        window.parent.addUserToStatusBar(clientRtcId, clientName, true);

        // Init Listeners
        easyrtc.setServerListener( function(msgType, msgData, targeting) {
          if(msgType === 'spawnComponent') {
            var newData = JSON.parse(msgData);
            var controller = document.querySelector('[object-control-desktop]').components['object-control-desktop'];
            controller.spawnEntity(newData);

          }else if(msgType === 'selectedComponent') {
            var data = JSON.parse(msgData);
            var cid = data.cid;
            var sourceRtcId = data.sourcertcid;
            var bool = data.bool;
            var controller = document.querySelector('[object-control-desktop]').components['object-control-desktop'];
            controller.selectEntity(cid, sourceRtcId, bool);

          }else if(msgType === 'removedComponent') {
            var data = JSON.parse(msgData);
            var cid = data.cid;
            var controller = document.querySelector('[object-control-desktop]').components['object-control-desktop'];
            controller.removeComponent(cid);

          }else if(msgType === 'updatedComponent') {
            var data = JSON.parse(msgData);
            var cid = data.cid;
            var type = data.updatetype;
            var newData = data.updatedata;
            var controller = document.querySelector('[object-control-desktop]').components['object-control-desktop'];
            controller.updateComponent(cid, type, newData);

          }else if(msgType === 'updatedInteractable') {
            var data = JSON.parse(msgData);
            var cid = data.cid;
            var sourceRtcId = data.sourcertcid;
            var newData = data.updatedata;
            var property = newData.property;
            var value = newData.value;
            var controller = document.querySelector('[object-control-desktop]').components['object-control-desktop'];
            controller.updateInteractable(cid, sourceRtcId, property, value);

          } else if(msgType === 'userJoined') {
            var data = JSON.parse(msgData);
            window.parent.addUserToStatusBar(data.easyrtcid, data.name, false);

          }else if(msgType === 'userLeft') {
            var data = JSON.parse(msgData);
            window.parent.removeUserFromStatusBar(data.easyrtcid);

          }else if(msgType === 'spawnInteraction') {
            var newData = JSON.parse(msgData);
            var controller = document.querySelector('[object-control-desktop]').components['object-control-desktop'];
            controller.spawnInteraction(newData);

          }else if(msgType === 'updatedInteraction') {
            var newData = JSON.parse(msgData);
            var controller = document.querySelector('[object-control-desktop]').components['object-control-desktop'];
            controller.updateInteraction(newData);

          }else if(msgType === 'removedInteraction') {
            var newData = JSON.parse(msgData);
            var controller = document.querySelector('[object-control-desktop]').components['object-control-desktop'];
            controller.removeInteraction(newData);

          }else if(msgType === 'selectedTasks') {
            var newData = JSON.parse(msgData);
            var controller = document.querySelector('[object-control-desktop]').components['object-control-desktop'];
            controller.selectTasks(newData);

          }else if(msgType === 'addedTask') {
            var newData = JSON.parse(msgData);
            var controller = document.querySelector('[object-control-desktop]').components['object-control-desktop'];
            controller.addTask(newData);

          }else if(msgType === 'updatedTask') {
            var newData = JSON.parse(msgData);
            var controller = document.querySelector('[object-control-desktop]').components['object-control-desktop'];
            controller.updateTask(newData);

          }else{
            console.log("Received unknown message type '" + msgType + "'.");
          }
        });

        // Broadcast ClientName
        var obj = new Object();
        obj.easyrtcid = clientRtcId;
        obj.name = clientName;
        var clientData = JSON.stringify(obj);
        easyrtc.sendDataWS(clientRtcId, "broadcastUserName", clientData);

        // Fetch existing components from server
        easyrtc.sendDataWS(clientRtcId, "getAllComponents", null);
      }
    </script>
    <script>
      // Taskboard
      function addTaskButton() {
        easyrtc.sendDataWS(clientRtcId, "addTask", null);
      }

      function editTask(data){
        var taskboard = document.getElementById('taskboard');
        var task = document.getElementById('task' + data.id);
        task.setAttribute('value', data.value);
      }
    </script>
    <script>
      AFRAME.registerComponent('cursor-listener', {
        init: function () {
          this.el.addEventListener('raycaster-intersected', evt => {
            this.raycaster = evt.detail.el;
          });
          this.el.addEventListener('raycaster-intersected-cleared', evt => {
            this.raycaster = null;
          });
        },
        tick: function () {
            if (!this.raycaster) { return; }  // Not intersecting.
            let intersection = this.raycaster.components.raycaster.getIntersection(this.el);
            if (!intersection) { return; } // Not intersecting
            // intersecting
            /*
            console.log('Tick: ');
            console.log(this.el);
            */
        }
      });
    </script>
    <script>
      AFRAME.registerComponent('grab-axisslider-listener', {
        init: function () {
          var el = this.el;
          var pEl = el.parentEl;
          var axis = el.getAttribute('axis');
          var player = document.getElementById('player');
          var origin = null;

          el.addEventListener('mousedown', function handleSendSelect(event) {
            // Disable look-controls for the drag
            var lookController = player.getAttribute('look-controls');
            lookController.enabled = false;
            player.setAttribute('look-controls', lookController);

            // Start moving the object
            el.setAttribute('axis-grabbed', 'axis: ' + axis);
          });

          document.addEventListener("mousemove", (e) => {
            var axisGrabbed = el.getAttribute('axis-grabbed');
            if (axisGrabbed != null) {

              if(origin == null) {
                origin = new Object();
                origin.x = e.offsetX;
                origin.y = e.offsetY;
                return;
              }

              // Determine axis & offset
              var axis = axisGrabbed.axis;
              var offset;
              var offsetX = e.offsetX;
              var offsetY = e.offsetY;
             
              offset = offsetX - origin.x;
              origin.x = offsetX;

              // Map offset to position
              offset = offset/1000;
              var pos3 = pEl.getAttribute('position');
              pos3[axis] = pos3[axis] + offset;
              pEl.setAttribute('position', pos3);

              // Send changes to server
              var obj = new Object();
              var cid = pEl.getAttribute('cid');
              obj.cid = cid; 
              obj.updatetype = 'position';
              obj.updatedata = pos3;
              var newData = JSON.stringify(obj);
              easyrtc.sendDataWS(clientRtcId, "updateComponent", newData);

              // TODO: UPDATE POSITION IN PROPERTY WINDOW
              /*
              // Determine axis & offset
              var axis = axisGrabbed.axis;
              var offsetX = e.offsetX;
              var offsetY = e.offsetY;

              var diffX = offsetX - origin.x;
              var diffY = offsetY - origin.y;

              var offset = Math.sqrt(diffX*diffX + diffY*diffY)/1000;

              origin.x = e.offsetX;
              origin.y = e.offsetY;

              // Determine positive or negative
              var presign = this.posOrNeg(origin.x, origin.y, offsetX, offsetY);
              console.log(presign);

              // Map offset to position
              var pos3 = pEl.getAttribute('position');
              pos3[axis] = pos3[axis] + presign * offset;
              pEl.setAttribute('position', pos3);
              */
            }
          });

          el.addEventListener('mouseup', function handleSendSelect(event) {
            // Stop moving the object
            el.removeAttribute('axis-grabbed');
            origin = null;

            // Enable the look-controls after the drag
            var lookController = player.getAttribute('look-controls');
            lookController.enabled = true;
            player.setAttribute('look-controls', lookController);

            // Send the updated object position to server
            var obj = new Object();
            var pos = pEl.getAttribute('position');
            var cid = pEl.getAttribute('cid');
            obj.cid = cid; 
            obj.updatetype = 'position';
            obj.updatedata = pos;
            var newData = JSON.stringify(obj);
            easyrtc.sendDataWS(clientRtcId, "updateComponent", newData);
          });
        }
      });

      AFRAME.registerComponent('axis-grabbed', {
        schema: {
          axis: { default: "x" }
        },
        init: function () {
          var axis = this.data.axis;
          var mousePos = "";
        },

        tick: function () {
          /*
          var hand = null;
          var raycaster = null;
          var el = this.el;
          var pEl = el.parentEl;
          var axis = this.data.axis;
                    
          try {
            hand = document.getElementById('hand-right');
            raycaster = hand.components.raycaster;
          }catch(e) {
            return;
          }

          if(raycaster == null) {
            return;
          }

          // Handle Position
          var pos3 = hand.getAttribute('position');
          var tempPos3 = pos3.clone();
          var quaternion = raycaster.el.object3D.quaternion;
          var vector = new THREE.Vector3(0, 0, -1);
          vector.applyQuaternion( quaternion );
          tempPos3 = tempPos3.add(vector);
          
          var pPosition3 = pEl.getAttribute('position');
          var newPos3 = pPosition3.clone();
          newPos3[axis] = tempPos3[axis];
          pEl.setAttribute('position', newPos3);
          */
        }
      });
    </script>
    <!--link rel="stylesheet" type="text/css" href="/styles/Editor2.css" /-->
  </head>
  <body>
   <div class="middle-panel">
    <a-scene
      networked-scene="
        room: dev;
        debug: true;
        adapter: easyrtc;
        audio: true;
      "
      stats
    >
        <a-assets timeout="20000">
          <!-- Templates -->

          <!-- Avatar -->
          <template id="avatar-template">
            <a-entity class="avatar" scale="0.3 0.3 0.3" networked-audio-source>
              <a-sphere class="head" scale="0.45 0.5 0.4"></a-sphere>
              <a-entity class="face" position="0 0.05 0">
                <a-sphere class="eye" color="#efefef" position="0.16 0.1 -0.35" scale="0.12 0.12 0.12">
                  <a-sphere class="pupil" color="#000" position="0 0 -1" scale="0.2 0.2 0.2"></a-sphere>
                </a-sphere>
                <a-sphere class="eye" color="#efefef" position="-0.16 0.1 -0.35" scale="0.12 0.12 0.12">
                  <a-sphere class="pupil" color="#000" position="0 0 -1" scale="0.2 0.2 0.2"></a-sphere>
                </a-sphere>
              </a-entity>
            </a-entity>
          </template>

          <!-- Entity -->
          <template id="block-template">
            <a-entity>
              <a-box class="block" arrow-control selectable></a-box>
            </a-entity>
          </template>

          <!-- Grid -->
          <img id="grid" src="/img/grid.png">
          <img id="sky" src="/img/sky.jpg">

           <!-- TEXTURES -->
          <img id="kitchenwalls" src="img/wall_stone_4k.png" />

          <!-- MODELS -->
          <a-asset-item id="kitchen-obj" src="/assets/kitchen_module.obj"></a-asset-item>
          <a-asset-item id="kitchen-mtl" src="/assets/kitchen_module.mtl"></a-asset-item>

          <a-asset-item id="bowl" src="/assets/schuessel.obj"></a-asset-item>
          
          <a-asset-item id="righthand-model" src="/assets/rightHandHigh.glb"></a-asset-item>
          <a-asset-item id="lefthand-model" src="/assets/leftHandHigh.glb"></a-asset-item>

          <a-asset-item id="door" src="/assets/Door.obj"></a-asset-item>
          <a-asset-item id="window" src="/assets/win.obj"></a-asset-item>

        </a-assets>

        <!-- ENVIRONMENT -->
        <a-sky src="#sky" rotation="0 -90 0"></a-sky>

        <a-entity name="floor" geometry="primitive: plane" scale="6 6 1" rotation="-90 0 0" position="0 0 0" material="color: #51524c"></a-entity>
        <a-plane name="walln" geometry="primitive: plane" scale="6 2.5 1" rotation="0 0 0" position="0 1.25 -3" src="#kitchenwalls" repeat="12 5"></a-plane>
        <a-plane name="wallw" geometry="primitive: plane" scale="6 2.5 1" rotation="0 90 0" position="-3 1.25 0" src="#kitchenwalls" repeat="12 5"></a-plane>
        <a-plane name="walle" geometry="primitive: plane" scale="6 2.5 1" rotation="0 -90 0" position="3 1.25 0" src="#kitchenwalls" repeat="12 5"></a-plane>
        <a-plane name="walls" geometry="primitive: plane" scale="6 2.5 1" rotation="0 180 0" position="0 1.25 3" src="#kitchenwalls" repeat="12 5"></a-plane>

        <a-entity position="0.5 0 -3" scale="0.01 0.01 0.01" obj-model="obj: #kitchen-obj; mtl: #kitchen-mtl"></a-entity>

        <a-entity position="1.2 0.85 -2.4" scale="0.2 0.2 0.2" obj-model="obj: #bowl" material="src: /img/ceramic_white.jpg; color: #1b688c"></a-entity>
        <a-entity position="-0.1 0.85 -2.6" scale="0.2 0.2 0.2" obj-model="obj: #bowl" material="src: /img/ceramic_white.jpg; color: #1b688c"></a-entity>
        <a-entity position="-0.105 0.9 -2.605" scale="0.2 0.2 0.2" obj-model="obj: #bowl" material="src: /img/ceramic_white.jpg; color: #1b688c"></a-entity>
        <a-entity position="-0.11 0.95 -2.61" scale="0.2 0.2 0.2" obj-model="obj: #bowl" material="src: /img/ceramic_white.jpg; color: #1b688c"></a-entity>

        <!-- Light -->
        <a-entity light="color: #ccccff; intensity: 1; type: ambient;" visible="true"></a-entity>
        <a-entity light="type: point; intensity: 0.6; distance: 10; decay: 2" position="0 2.5 0"></a-entity>

        <!-- Taskboard -->
        <a-rounded radius="0.1" width="2" height="1" rotation="0 90 0" position="-2.99 1 0" color="#6C7A89">
          <a-entity id="taskboard" position="0.05 0.9 0" scale="0.3 0.3 0.3">
            <a-text position="0 0 0" value="Tasks:"></a-text>
            <!--a-text position="0 -0.3 0" value="1. blabla"></a-text-->
          </a-entity>
        </a-rounded>

        <a-entity id="rig">
          <a-entity
            id="player"
            networked="template:#avatar-template;attachTemplateToLocal:false;"
            camera
            position="0 1.6 0"
            spawn-in-circle="radius:3"
            object-control-desktop="template:#block-template"
            wasd-controls="fly:true;"
            look-controls
            cursor="rayOrigin: mouse"
          >
          <!-- 
            raycaster="objects: .cursor-listener"
          -->
            <a-sphere id="playerhead" class="head" visible="false" random-color></a-sphere>
          </a-entity>
        </a-entity>

         <!-- Environment -->
        <!--a-entity position="0 0 0"
          geometry="primitive: plane; width: 10000; height: 10000;" rotation="-90 0 0"
          material="src: #grid; repeat: 10000 10000; transparent: true; metalness:0.6; roughness: 0.4; sphericalEnvMap: #sky;"
        ></a-entity-->

        <!--a-entity gltf-model="#kitchenModel"></a-entity-->
        <!--a-entity scale="0.6 0.6 0.6" obj-model="obj: #kitchen-obj; mtl: #kitchen-mtl"></a-entity-->

      </a-scene>
    </div>

    <div class="controls">
      <p>Use WASD-Keys to fly around. Click on a component to select it and edit its properties.</p>
    </div>
  </body>
</html>