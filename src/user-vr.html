<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Select & move objects</title>
    <meta name="description" content="VREUD Example - Aframe" />

    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.5.0/socket.io.slim.js"></script>
    <script src="/easyrtc/easyrtc.js"></script>
    <script src="/dist/networked-aframe.js"></script>
    <script>
      AFRAME.registerComponent('thumbstick-controls',{
        init: function () {
          this.el.addEventListener('thumbstickmoved', this.thumbstickControl);
        },
        thumbstickControl: function (evt) {

          var pos = this.getAttribute('position');
          console.log(pos);

          if (evt.detail.y > 0.95) { 
            console.log("DOWN"); 
          }
          if (evt.detail.y < -0.95) { 
            console.log("UP"); 
          }
          if (evt.detail.x < -0.95) { 
            console.log("LEFT"); 
          }
          if (evt.detail.x > 0.95) { 
            console.log("RIGHT"); 
          }
        }
      });
    </script>
    <script>
      // see issue https://github.com/networked-aframe/networked-aframe/issues/267
      NAF.schemas.getComponentsOriginal = NAF.schemas.getComponents;
      NAF.schemas.getComponents = (template) => {
        if (!NAF.schemas.hasTemplate('#avatar-template')) {
          NAF.schemas.add({
            template: '#avatar-template',
            components: [
              'position',
              'rotation',
              {
                selector: '.head',
                component: 'material',
                property: 'color'
              }
            ]
          });

          if (!NAF.schemas.hasTemplate('#block-template')) {
            NAF.schemas.add({
              template: '#block-template',
              components: [
                'position',
                {
                  selector: '.block',
                  component: 'rotation'
                },
                {
                  selector: '.block',
                  component: 'position'
                },
                {
                  selector: '.block',
                  component: 'material',
                  property: 'color'
                },
                {
                  selector: '.block',
                  component: 'select-entity',
                  property: 'direction'
                }
              ]
            });
          }
        }
        const components = NAF.schemas.getComponentsOriginal(template);
        return components;
      };
    </script>
    <script>
      AFRAME.registerComponent('selectable', {
        schema: {
          targetable: {default: true}
        },

        init: function () {
          var data = this.data;
          var el = this.el; 

          // Get component id
          var componentId = el.getAttribute('cid');

          // Create data object to stringify
          var obj = new Object();
          obj.cid = componentId;

          var entityData = JSON.stringify(obj); 

          // Add click listener
          el.addEventListener('click', function() {
            var targetable = data.targetable;
            if(targetable) {
              console.log("Sending: 'Select object with component-id:' " + entityData);
              easyrtc.sendDataWS(clientRtcId, "selectComponent", entityData);
            }else{
              console.log("Tried to select untargetable entity.");
            }
          });
        }
      });
    </script>
    <script src="https://unpkg.com/aframe-randomizer-components@^3.0.1/dist/aframe-randomizer-components.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.1/dist/aframe-environment-component.min.js"></script>
    <script src="/js/spawn-in-circle.component.js"></script>
    <script src="/js/object-control-vr.component.js"></script>
    <script>
      let clientRtcId;

      // Called by Networked-Aframe when connected to server
      function onConnect() {        
        // Set clients easyrtcid
        clientRtcId = NAF.clientId;
        clientName = window.parent.clientName;

        // Send clientId to statusbar
        //window.parent.addUserToStatusBar(clientRtcId, true);
        serverJoinedSetup();
      }
    </script>
    <script>
      function serverJoinedSetup() {
        // Add own name to statusbar
        // TODO: Make VR ready
        //window.parent.addUserToStatusBar(clientRtcId, clientName, true);

        // Init Listeners
        easyrtc.setServerListener( function(msgType, msgData, targeting) {
          if(msgType === 'spawnComponent') {
            var newData = JSON.parse(msgData);
            var controller = document.querySelector('[object-control-vr]').components['object-control-vr'];
            console.log("controller:");
            console.log(controller);
            controller.spawnEntity(newData);

          }else if(msgType === 'selectedComponent') {
            var data = JSON.parse(msgData);
            var cid = data.cid;
            var sourceRtcId = data.sourcertcid;
            var bool = data.bool;
            var controller = document.querySelector('[object-control-vr]').components['object-control-vr'];
            controller.selectEntity(cid, sourceRtcId, bool);

          }else if(msgType === 'removedComponent') {
            var data = JSON.parse(msgData);
            var cid = data.cid;
            var controller = document.querySelector('[object-control-vr]').components['object-control-vr'];
            controller.removeComponent(cid);
          }else if(msgType === 'updatedComponent') {
            var data = JSON.parse(msgData);
            var cid = data.cid;
            var type = data.updatetype;
            var newData = data.updatedata;
            var controller = document.querySelector('[object-control-vr]').components['object-control-vr'];
            controller.updateComponent(cid, type, newData);

          } else if(msgType === 'userJoined') {
            var data = JSON.parse(msgData);
            window.parent.addUserToStatusBar(data.easyrtcid, data.name, false);

          }else if(msgType === 'userLeft') {
            var data = JSON.parse(msgData);
            window.parent.removeUserFromStatusBar(data.easyrtcid);
          }
        });

        // Broadcast ClientName
        var obj = new Object();
        obj.easyrtcid = clientRtcId;
        obj.name = clientName;
        var clientData = JSON.stringify(obj);
        easyrtc.sendDataWS(clientRtcId, "broadcastUserName", clientData);

      }
    </script>
    <script>
      AFRAME.registerComponent('cursor-listener', {
        init: function () {
          this.el.addEventListener('raycaster-intersected', evt => {
            this.raycaster = evt.detail.el;
          });
          this.el.addEventListener('raycaster-intersected-cleared', evt => {
            this.raycaster = null;
          });
        },
        tick: function () {
            if (!this.raycaster) { return; }  // Not intersecting.
            let intersection = this.raycaster.components.raycaster.getIntersection(this.el);
            if (!intersection) { return; } // Not intersecting
            // intersecting
        }
      });
    </script>
    <script>
      AFRAME.registerComponent('collider-check', {
        dependencies: ['raycaster'],

        init: function () {
          this.el.addEventListener('raycaster-intersection', function () {
          });
        }
      });

      AFRAME.registerComponent('raycaster-listen', {
        init: function () {
          var el = this.el;
          // Use events to figure out what raycaster is listening so we don't have to
          // hardcode the raycaster.
          this.el.addEventListener('raycaster-intersected', evt => {
            this.raycaster = evt.detail.el;
          });


          this.el.addEventListener('raycaster-intersected-cleared', evt => {
            this.raycaster = null;
          });
        },

        tick: function () {
          if (!this.raycaster) { return; }  // Not intersecting.

          let intersection = this.raycaster.components.raycaster.getIntersection(this.el);
          if (!intersection) { return; }

          this.el.setAttribute('material', 'color: #0000ff');
          
        }
      });
    </script>
    <link rel="stylesheet" type="text/css" href="/css/style.css" />
  </head>
  <body>
    <a-scene
      networked-scene="
        room: dev;
        debug: true;
        adapter: easyrtc;
        audio: true;
      "
    >
      <a-assets>
        <!-- Templates -->

        <!-- Avatar -->
        <template id="avatar-template">
          <a-entity class="avatar" networked-audio-source>
            <a-sphere class="head" scale="0.45 0.5 0.4"></a-sphere>
            <a-entity class="face" position="0 0.05 0">
              <a-sphere class="eye" color="#efefef" position="0.16 0.1 -0.35" scale="0.12 0.12 0.12">
                <a-sphere class="pupil" color="#000" position="0 0 -1" scale="0.2 0.2 0.2"></a-sphere>
              </a-sphere>
              <a-sphere class="eye" color="#efefef" position="-0.16 0.1 -0.35" scale="0.12 0.12 0.12">
                <a-sphere class="pupil" color="#000" position="0 0 -1" scale="0.2 0.2 0.2"></a-sphere>
              </a-sphere>
            </a-entity>
          </a-entity>
        </template>

        <!-- Entity -->
        <template id="block-template">
          <a-entity>
            <a-box class="block" arrow-control selectable></a-box>
          </a-entity>
        </template>

        <!-- Grid -->
        <img id="grid" src="/img/grid.png">
        <img id="sky" src="/img/sky.jpg">
      </a-assets>

      <!-- TODO: REMOVE THIS TEMPORARY TEST ENTITY -->
      <a-plane 
            class="vr-menu-panel" 
            color="#80160e" 
            position="0 1.4 -0.9"
            rotation="-30 0 0" 
            scale="1 0.3 0.3"
            visible="true"
          >
            <a-box
              class="box" 
              color="#23ddeb" 
              position="0.33 0 -0.03"
              rotation="0 0 0" 
              scale="0.3 0.9 0.1"
              visible="true"
              vr-menu
            >
            </a-box>
      </a-plane>
      <a-entity id="rig">
        <a-entity
          id="player"
          networked="template:#avatar-template;attachTemplateToLocal:false;"
          camera
          look-controls
          position="0 1.6 0"
          spawn-in-circle="radius:3"
          object-control-vr="template:#block-template"
        >
          <a-sphere id="playerhead" class="head" visible="false" random-color></a-sphere>
          <a-cursor></a-cursor>
        </a-entity>
      </a-entity>


      <a-entity oculus-touch-controls="hand: left">
        <a-entity class="collidable" geometry="primitive: box" material="color: #000000" scale="0.1 0.1 0.1"></a-entity>
      </a-entity>
      <a-entity 
        oculus-touch-controls="hand: right"
        raycaster="objects: .collidable; showLine: true"
        ></a-entity>
      </a-entity>
      <a-entity class="collidable" raycaster-listen geometry="primitive: box" material="color: #000000" position="5 0 0"></a-entity>


      <!-- Environment -->
      <a-entity position="0 0 0"
        geometry="primitive: plane; width: 10000; height: 10000;" rotation="-90 0 0"
        material="src: #grid; repeat: 10000 10000; transparent: true; metalness:0.6; roughness: 0.4; sphericalEnvMap: #sky;"
      ></a-entity>
      <a-entity light="color: #ccccff; intensity: 1; type: ambient;" visible=""></a-entity>
      <a-entity light="color: #ffaaff; intensity: 1.5" position="5 5 5"></a-entity>
      <a-sky src="#sky" rotation="0 -90 0"></a-sky>
    </a-scene>

    <div class="controls">
      <p>Description pending...</p>
    </div>
  </body>
</html>
